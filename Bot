# main.py
import os
import random
from datetime import datetime, timedelta

import telebot
from telebot import types
from pymongo import MongoClient, ReturnDocument
from dotenv import load_dotenv

# === ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© (Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙŠØ³ØªØ®Ø¯Ù… .env) ===
load_dotenv()

# === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - Ø¶Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ Render Environment Ø£Ùˆ ÙÙŠ Ù…Ù„Ù .env Ù…Ø­Ù„ÙŠÙ‹Ø§ ===
TOKEN = os.getenv("TOKEN") or "8455107490:AAEbIFpHcKw3nWtiJkvtMMc6petNo5wZzm0"
CHANNEL = os.getenv("CHANNEL") or "@Youssef_Osama2005"   # Ù…Ø«Ø§Ù„: @Youssef_Osama2005
DEV_ID = int(os.getenv("7938146499") or 0)                 # Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠ Ø¯ÙŠ Ù„Ù„Ù…Ø·ÙˆØ± (Ù…Ø«Ù„Ø§Ù‹: 7938146499)
MONGO_URI = os.getenv("MONGO_URI")                    # URI Ù…Ù† MongoDB Atlas
DB_NAME = os.getenv("DB_NAME") or "telegram_bank_db"

if not MONGO_URI:
    raise RuntimeError("ERROR: MONGO_URI ØºÙŠØ± Ù…Ø¹Ø±Ù. Ø¶Ø¹ MONGO_URI ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©.")

# === ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===
bot = telebot.TeleBot(TOKEN)
client = MongoClient(MONGO_URI)
db = client[DB_NAME]

users_col = db["users"]
transactions_col = db["transactions"]
shops_col = db["shops"]
marriage_col = db["marriages"]
clubs_col = db["clubs"]
cooldowns_col = db["cooldowns"]
stats_col = db["stats"]
questions_col = db["questions"]
fun_col = db["fun"]

# === Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ===
def format_money(x):
    try:
        return f"{int(x)} â‚¿"
    except:
        return "0 â‚¿"

def require_subscription(user_id):
    try:
        member = bot.get_chat_member(CHANNEL, user_id)
        return member.status in ["creator", "administrator", "member"]
    except Exception:
        return False

def send_subscription_prompt(chat_id):
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("ğŸ“¢ Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©", url=f"https://t.me/{CHANNEL.replace('@','')}"))
    bot.send_message(chat_id, f"âš ï¸ Ù„Ø§Ø²Ù… ØªØ´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ù‹Ø§: {CHANNEL}\nØ¨Ø¹Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§ÙƒØªØ¨ /start", reply_markup=markup)

def ensure_user_account(chat_id, user):
    """Return user doc; create if not exists."""
    chat = int(chat_id)
    uid = int(user.id)
    doc = users_col.find_one({"chat_id": chat, "user_id": uid})
    if doc:
        # ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ùˆ ØªØºÙŠÙ‘Ø±
        if user.first_name and doc.get("username") != user.first_name:
            users_col.update_one({"_id": doc["_id"]}, {"$set": {"username": user.first_name}})
        return users_col.find_one({"chat_id": chat, "user_id": uid})
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯
    acc_num = str(random.randint(100000, 999999))
    new = {
        "chat_id": chat,
        "user_id": uid,
        "username": user.first_name or "Ù…Ø³ØªØ®Ø¯Ù…",
        "balance": 0,
        "account_number": acc_num,
        "has_account": False,
        "assets": [],
        "created_at": datetime.utcnow(),
        "stats": {"earned":0,"spent":0,"received":0,"transfers":0}
    }
    users_col.insert_one(new)
    return users_col.find_one({"chat_id": chat, "user_id": uid})

def get_user_by_account(chat_id, acc_num):
    return users_col.find_one({"chat_id": int(chat_id), "account_number": str(acc_num)})

def record_transaction(chat_id, kind, from_user, to_user, amount, note=""):
    transactions_col.insert_one({
        "chat_id": int(chat_id),
        "kind": kind,
        "from_user": int(from_user) if from_user else None,
        "to_user": int(to_user) if to_user else None,
        "amount": int(amount),
        "note": note,
        "ts": datetime.utcnow()
    })

def set_cooldown(chat_id, user_id, name, seconds):
    key = {"chat_id": int(chat_id), "user_id": int(user_id), "name": name}
    expires = datetime.utcnow() + timedelta(seconds=seconds)
    cooldowns_col.update_one(key, {"$set": {"expires_at": expires}}, upsert=True)

def cooldown_remaining(chat_id, user_id, name):
    rec = cooldowns_col.find_one({"chat_id": int(chat_id), "user_id": int(user_id), "name": name})
    if not rec: return 0
    rem = (rec["expires_at"] - datetime.utcnow()).total_seconds()
    return int(rem) if rem>0 else 0

# === ØªÙ‡ÙŠØ¦Ø© Ù…Ø¹Ø±Ø¶ Ù…Ø¨Ø¯Ø¦ÙŠ Ù„Ùˆ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ ===
if shops_col.count_documents({}) == 0:
    shops_col.insert_many([
        {"item_id": "car1", "name": "Ø³ÙŠØ§Ø±Ø© Ø±ÙŠØ§Ø¶ÙŠØ©", "price": 500},
        {"item_id": "house1", "name": "Ø¨ÙŠØª ØµØºÙŠØ±", "price": 1000},
        {"item_id": "farm1", "name": "Ù…Ø²Ø±Ø¹Ø©", "price": 300}
    ])

# === Ø£ÙˆØ§Ù…Ø± Ø£Ø³Ø§Ø³ÙŠØ© ÙˆÙ‚Ø§Ø¦Ù…Ø© ===
@bot.message_handler(commands=['start'])
def cmd_start(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    ensure_user_account(m.chat.id, m.from_user)
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸ¦ Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ù†Ùƒ", "ğŸ® Ø§Ù„Ø¹Ø§Ø¨")
    markup.add("ğŸ˜‚ ØªØ³Ù„ÙŠØ©", "ğŸ“Š Ø±ØµÙŠØ¯ÙŠ")
    markup.add("ğŸ† ØªÙˆØ¨ Ø§Ù„ÙÙ„ÙˆØ³", "ğŸ•¹ Ø§Ù„Ø¹Ø§Ø¨ Ø¬Ø¯ÙŠØ¯Ø©")
    if m.from_user.id == DEV_ID:
        markup.add("ğŸ”§ Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø·ÙˆØ±")
    bot.send_message(m.chat.id, f"Ø£Ù‡Ù„Ø§Ù‹ {m.from_user.first_name} ğŸ‘‹\nØ§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:", reply_markup=markup)

# === Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ù†Ùƒ: Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ===
@bot.message_handler(func=lambda msg: msg.text == "ğŸ¦ Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ù†Ùƒ")
def bank_menu(msg):
    if not require_subscription(msg.from_user.id):
        send_subscription_prompt(msg.chat.id); return
    text = (
        "â˜† Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ù†Ùƒ\n\n"
        "âŒ¯ Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ\nâŒ¯ Ù…Ø³Ø­ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ\nâŒ¯ ØªØ­ÙˆÙŠÙ„\nâŒ¯ Ø­Ø³Ø§Ø¨ÙŠ\nâŒ¯ ÙÙ„ÙˆØ³ÙŠ\nâŒ¯ Ø±Ø§ØªØ¨\nâŒ¯ Ø¨Ø®Ø´ÙŠØ´\nâŒ¯ Ø²Ø±Ù\nâŒ¯ Ø§Ø³ØªØ«Ù…Ø§Ø±\nâŒ¯ Ø­Ø¸\nâŒ¯ Ù…Ø¶Ø§Ø±Ø¨Ù‡\nâŒ¯ Ù‡Ø¬ÙˆÙ…\nâŒ¯ ÙƒÙ†Ø²\nâŒ¯ Ù…Ø±Ø§Ù‡Ù†Ù‡\nâŒ¯ ØªÙˆØ¨ Ø§Ù„ÙÙ„ÙˆØ³\nâŒ¯ ØªÙˆØ¨ Ø§Ù„Ø²Ø±Ù\nâŒ¯ Ø²ÙˆØ§Ø¬\nâŒ¯ Ø²ÙˆØ§Ø¬ÙŠ\nâŒ¯ Ø·Ù„Ø§Ù‚\nâŒ¯ Ù…Ø¹Ø±Ø¶\nâŒ¯ Ø´Ø±Ø§Ø¡\nâŒ¯ Ù…Ù…ØªÙ„ÙƒØ§ØªÙŠ\nâŒ¯ ØªØ¨Ø±Ø¹\nâŒ¯ Ø§Ù†Ø´Ø§Ø¡ Ù†Ø§Ø¯ÙŠ\nâŒ¯ Ø´Ø±Ø§Ø¡ Ù„Ø§Ø¹Ø¨\n"
    )
    bot.send_message(msg.chat.id, text)

# === Ø§Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ ===
@bot.message_handler(func=lambda m: m.text == "Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ")
def create_account(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    doc = ensure_user_account(m.chat.id, m.from_user)
    if doc.get("has_account"):
        bot.reply_to(m, "â— Ù„Ø¯ÙŠÙƒ Ø¨Ø§Ù„ÙØ¹Ù„ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ.")
        return
    users_col.update_one({"chat_id": doc["chat_id"], "user_id": doc["user_id"]}, {"$set": {"has_account": True, "balance": 100}})
    bot.reply_to(m, f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ: `{doc['account_number']}`\nØ±ØµÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: {format_money(100)}", parse_mode='Markdown')

# === Ù…Ø³Ø­ Ø§Ù„Ø­Ø³Ø§Ø¨ ===
@bot.message_handler(func=lambda m: m.text == "Ù…Ø³Ø­ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ")
def delete_account(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    doc = ensure_user_account(m.chat.id, m.from_user)
    if not doc.get("has_account"):
        bot.reply_to(m, "â— Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ.")
        return
    users_col.update_one({"chat_id": doc["chat_id"], "user_id": doc["user_id"]}, {"$set": {"has_account": False, "balance": 0}})
    bot.reply_to(m, "âœ… ØªÙ… Ù…Ø³Ø­ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¨Ù†ÙƒÙŠ.")

# === Ø­Ø³Ø§Ø¨ÙŠ ÙˆÙÙ„ÙˆØ³ÙŠ ===
@bot.message_handler(func=lambda m: m.text == "Ø­Ø³Ø§Ø¨ÙŠ")
def show_account(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    doc = ensure_user_account(m.chat.id, m.from_user)
    bot.reply_to(m, f"ğŸ“¬ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ: `{doc['account_number']}`", parse_mode='Markdown')

@bot.message_handler(func=lambda m: m.text == "ÙÙ„ÙˆØ³ÙŠ")
def show_balance(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    doc = ensure_user_account(m.chat.id, m.from_user)
    bot.reply_to(m, f"ğŸ’  Ø±ØµÙŠØ¯Ùƒ: {format_money(doc.get('balance',0))}")

# === ØªØ­ÙˆÙŠÙ„ (Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ) ===
@bot.message_handler(commands=['transfer','ØªØ­ÙˆÙŠÙ„'])
def transfer_cmd(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    if not m.reply_to_message:
        bot.reply_to(m, "â— Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ÙˆÙŠÙ„Ù‡ Ø£Ùˆ Ø§ÙƒØªØ¨: /transfer <amount> (Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…)."); return
    try:
        amount = int(m.text.split()[1])
    except:
        bot.reply_to(m, "â— Ø§Ù„ØµÙŠØºØ©: /transfer <amount>"); return
    sender = ensure_user_account(m.chat.id, m.from_user)
    receiver = ensure_user_account(m.chat.id, m.reply_to_message.from_user)
    if not sender.get("has_account"):
        bot.reply_to(m, "â— Ø§ÙØªØ­ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ø£ÙˆÙ„Ø§Ù‹"); return
    if not receiver.get("has_account"):
        bot.reply_to(m, "â— Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ"); return
    if sender.get("balance",0) < amount:
        bot.reply_to(m, "âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ."); return
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": -amount}})
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.reply_to_message.from_user.id}, {"$inc": {"balance": amount, "stats.received": amount}})
    record_transaction(m.chat.id, "transfer", m.from_user.id, m.reply_to_message.from_user.id, amount, note="user transfer")
    bot.reply_to(m, f"âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ {format_money(amount)} Ø¥Ù„Ù‰ {m.reply_to_message.from_user.first_name}.")

# === Ø±Ø§ØªØ¨ (cooldown 10 Ø¯Ù‚Ø§Ø¦Ù‚) ===
@bot.message_handler(func=lambda m: m.text == "Ø±Ø§ØªØ¨")
def pay_salary(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    rem = cooldown_remaining(m.chat.id, m.from_user.id, "salary")
    if rem > 0:
        bot.reply_to(m, f"âŒ› ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ø¹Ø¯ {rem} Ø«Ø§Ù†ÙŠØ©.")
        return
    doc = ensure_user_account(m.chat.id, m.from_user)
    if not doc.get("has_account"):
        bot.reply_to(m, "â— Ø§ÙØªØ­ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ø£ÙˆÙ„Ø§Ù‹."); return
    amount = random.randint(20,50)
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": amount}})
    set_cooldown(m.chat.id, m.from_user.id, "salary", 600)
    record_transaction(m.chat.id, "salary", None, m.from_user.id, amount)
    bot.reply_to(m, f"ğŸ’µ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø§ØªØ¨: {format_money(amount)}")

# === Ø¨Ø®Ø´ÙŠØ´ (cooldown 10 Ø¯Ù‚Ø§Ø¦Ù‚) ===
@bot.message_handler(func=lambda m: m.text == "Ø¨Ø®Ø´ÙŠØ´")
def tip_cmd(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    rem = cooldown_remaining(m.chat.id, m.from_user.id, "tip")
    if rem > 0:
        bot.reply_to(m, f"âŒ› ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨Ø®Ø´ÙŠØ´ Ø¨Ø¹Ø¯ {rem} Ø«Ø§Ù†ÙŠØ©."); return
    amount = random.randint(5,15)
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": amount}})
    set_cooldown(m.chat.id, m.from_user.id, "tip", 600)
    record_transaction(m.chat.id, "tip", None, m.from_user.id, amount)
    bot.reply_to(m, f"ğŸ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø¨Ø®Ø´ÙŠØ´: {format_money(amount)}")

# === Ø²Ø±Ù (cooldown 10 Ø¯Ù‚Ø§Ø¦Ù‚) ===
@bot.message_handler(func=lambda m: m.text == "Ø²Ø±Ù")
def zarf_cmd(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    rem = cooldown_remaining(m.chat.id, m.from_user.id, "zarf")
    if rem > 0:
        bot.reply_to(m, f"âŒ› ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø²Ø±Ù Ø¨Ø¹Ø¯ {rem} Ø«Ø§Ù†ÙŠØ©."); return
    amount = random.randint(10,40)
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": amount, "stats.received": amount}})
    set_cooldown(m.chat.id, m.from_user.id, "zarf", 600)
    stats_col.update_one({"chat_id": m.chat.id}, {"$inc": {"zarf_count": 1}}, upsert=True)
    record_transaction(m.chat.id, "zarf", None, m.from_user.id, amount)
    bot.reply_to(m, f"ğŸª™ ØªÙ… Ø²Ø±ÙÙƒ: {format_money(amount)}")

# === Ø§Ø³ØªØ«Ù…Ø§Ø± ===
@bot.message_handler(func=lambda m: m.text == "Ø§Ø³ØªØ«Ù…Ø§Ø±")
def invest_prompt(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    bot.reply_to(m, "âœ³ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ«Ù…Ø§Ø±Ù‡ Ø§Ù„Ø¢Ù† (Ù…Ø«Ø§Ù„: 50) ÙƒØ±Ø³Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø©:")
    bot.register_next_step_handler(m, invest_do)

def invest_do(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    try:
        amount = int(m.text.strip())
    except:
        bot.reply_to(m, "â— Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… ØµØ­ÙŠØ­."); return
    acc = ensure_user_account(m.chat.id, m.from_user)
    if not acc.get("has_account"):
        bot.reply_to(m, "â— Ø§ÙØªØ­ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ø£ÙˆÙ„Ø§."); return
    if acc.get("balance",0) < amount:
        bot.reply_to(m, "âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ."); return
    pct = random.randint(1,15)
    profit = int(amount * pct / 100)
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": -amount}})
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": profit}})
    record_transaction(m.chat.id, "invest", m.from_user.id, m.from_user.id, profit, note=f"invest {pct}%")
    bot.reply_to(m, f"ğŸ“ˆ Ø§Ø³ØªØ«Ù…Ø±Øª {format_money(amount)} ÙˆØ±Ø¨Ø­Øª {format_money(profit)} ({pct}%).")

# === Ø­Ø¸ ===
@bot.message_handler(func=lambda m: m.text == "Ø­Ø¸")
def gamble_prompt(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    bot.reply_to(m, "ğŸ² Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ù‡Ù†Ø© Ø¨Ù‡ (Ù…Ø«Ø§Ù„: 50):")
    bot.register_next_step_handler(m, gamble_do)

def gamble_do(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    try:
        amount = int(m.text.strip())
    except:
        bot.reply_to(m, "â— Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… ØµØ­ÙŠØ­."); return
    acc = ensure_user_account(m.chat.id, m.from_user)
    if acc.get("balance",0) < amount:
        bot.reply_to(m, "âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ."); return
    if random.random() < 0.5:
        users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": amount}})
        record_transaction(m.chat.id, "gamble_win", None, m.from_user.id, amount)
        bot.reply_to(m, f"ğŸ‰ ÙØ²Øª! Ø±Ø¨Ø­Ùƒ {format_money(amount)}")
    else:
        users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": -amount}})
        record_transaction(m.chat.id, "gamble_loss", m.from_user.id, None, amount)
        bot.reply_to(m, f"ğŸ˜¢ Ø®Ø³Ø±Øª {format_money(amount)}")

# === Ù…Ø¶Ø§Ø±Ø¨Ù‡ ===
@bot.message_handler(func=lambda m: m.text == "Ù…Ø¶Ø§Ø±Ø¨Ù‡")
def spec_prompt(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    bot.reply_to(m, "âš ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨Ø© Ø¨Ù‡ (Ù…Ø«Ø§Ù„: 100):")
    bot.register_next_step_handler(m, spec_do)

def spec_do(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    try:
        amount = int(m.text.strip())
    except:
        bot.reply_to(m, "â— Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… ØµØ­ÙŠØ­."); return
    acc = ensure_user_account(m.chat.id, m.from_user)
    if acc.get("balance",0) < amount:
        bot.reply_to(m, "âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ."); return
    pct = random.randint(-90,90)
    result = int(amount * pct / 100)
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": result}})
    record_transaction(m.chat.id, "speculation", m.from_user.id, None, result, note=f"spec {pct}%")
    if result >= 0:
        bot.reply_to(m, f"ğŸš€ Ø±Ø¨Ø­: {format_money(result)} ({pct}%)")
    else:
        bot.reply_to(m, f"ğŸ’¥ Ø®Ø³Ø§Ø±Ø©: {format_money(-result)} ({pct}%)")

# === Ù‡Ø¬ÙˆÙ… ===
@bot.message_handler(func=lambda m: m.text == "Ù‡Ø¬ÙˆÙ…")
def attack_prompt(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    bot.reply_to(m, "âš ï¸ Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¶Ø­ÙŠØ© ÙˆØ§ÙƒØªØ¨: /attack <amount>")

@bot.message_handler(commands=['attack'])
def attack_cmd(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    if not m.reply_to_message:
        bot.reply_to(m, "â— Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¶Ø­ÙŠØ© Ø«Ù… Ø§ÙƒØªØ¨: /attack <amount>"); return
    try:
        amount = int(m.text.split()[1])
    except:
        bot.reply_to(m, "â— Ø§Ù„ØµÙŠØºØ©: /attack <amount>"); return
    attacker = ensure_user_account(m.chat.id, m.from_user)
    victim = ensure_user_account(m.chat.id, m.reply_to_message.from_user)
    if attacker.get("balance",0) < amount:
        bot.reply_to(m, "âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ."); return
    if random.random() < 0.6:
        stolen = int(amount * random.uniform(0.1,0.5))
        users_col.update_one({"chat_id": m.chat.id, "user_id": m.reply_to_message.from_user.id}, {"$inc": {"balance": -stolen}})
        users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": stolen}})
        record_transaction(m.chat.id, "attack", m.from_user.id, m.reply_to_message.from_user.id, stolen)
        bot.reply_to(m, f"ğŸ”ª Ù†Ø¬Ø­Øª! Ø³Ø±Ù‚Øª {format_money(stolen)}")
    else:
        users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": -amount}})
        record_transaction(m.chat.id, "attack_fail", m.from_user.id, m.reply_to_message.from_user.id, amount)
        bot.reply_to(m, f"âŒ ÙØ´Ù„ Ø§Ù„Ù‡Ø¬ÙˆÙ… ÙˆØ®Ø³Ø±Øª {format_money(amount)}")

# === ÙƒÙ†Ø² ===
@bot.message_handler(func=lambda m: m.text == "ÙƒÙ†Ø²")
def chest_cmd(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    amount = random.choice([20,50,100,200])
    if random.random() < 0.5:
        bot.reply_to(m, "ğŸª¦ Ù„Ù„Ø£Ø³Ù Ù„Ù… ØªØ¬Ø¯ Ø´ÙŠØ¦Ù‹Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©.")
    else:
        ensure_user_account(m.chat.id, m.from_user)
        users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": amount}})
        record_transaction(m.chat.id, "chest", None, m.from_user.id, amount)
        bot.reply_to(m, f"ğŸ‰ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ÙƒÙ†Ø²: {format_money(amount)}")

# === ØªÙˆØ¨ Ø§Ù„ÙÙ„ÙˆØ³ Ùˆ ØªÙˆØ¨ Ø§Ù„Ø²Ø±Ù ===
@bot.message_handler(func=lambda m: m.text == "ØªÙˆØ¨ Ø§Ù„ÙÙ„ÙˆØ³")
def top_money(m):
    cursor = users_col.find({"chat_id": int(m.chat.id), "has_account": True}).sort("balance", -1).limit(10)
    msg = "ğŸ† ØªÙˆØ¨ Ø§Ù„Ø£ØºÙ†ÙŠØ§Ø¡ ÙÙŠ Ø§Ù„Ø¬Ø±ÙˆØ¨:\n"
    i = 1
    for doc in cursor:
        msg += f"{i}. {doc.get('username','Ù…Ø³ØªØ®Ø¯Ù…')} â€” {format_money(doc.get('balance',0))}\n"
        i += 1
    bot.reply_to(m, msg)

@bot.message_handler(func=lambda m: m.text == "ØªÙˆØ¨ Ø§Ù„Ø²Ø±Ù")
def top_zarf(m):
    st = stats_col.find_one({"chat_id": m.chat.id}) or {}
    zarf_count = st.get("zarf_count", 0)
    bot.reply_to(m, f"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø±Ù ÙÙŠ Ø§Ù„Ø¬Ø±ÙˆØ¨: {zarf_count}")

# === Ø²ÙˆØ§Ø¬ / Ø²ÙˆØ§Ø¬ÙŠ / Ø·Ù„Ø§Ù‚ ===
@bot.message_handler(func=lambda m: m.text == "Ø²ÙˆØ§Ø¬")
def marry_prompt(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    bot.reply_to(m, "ğŸ’ Ù„Ù„Ø²ÙˆØ§Ø¬: Ø±ÙØ¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ ÙˆØ§ÙƒØªØ¨: /marry <dowry>")

@bot.message_handler(commands=['marry'])
def marry_cmd(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    if not m.reply_to_message:
        bot.reply_to(m, "â— Ø±ÙØ¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø¬ Ø¨Ù‡."); return
    try:
        dowry = int(m.text.split()[1])
    except:
        bot.reply_to(m, "â— Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù‡Ø± Ù…Ø«Ø§Ù„: /marry 100"); return
    groom = ensure_user_account(m.chat.id, m.from_user)
    bride = ensure_user_account(m.chat.id, m.reply_to_message.from_user)
    if groom.get("balance",0) < dowry:
        bot.reply_to(m, "âŒ Ù…Ø¹Ù†Ø¯ÙƒØ´ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ."); return
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": -dowry}})
    marriage_col.insert_one({"chat_id": m.chat.id, "husband": m.from_user.id, "wife": m.reply_to_message.from_user.id, "dowry": dowry, "ts": datetime.utcnow()})
    record_transaction(m.chat.id, "marry", m.from_user.id, m.reply_to_message.from_user.id, dowry)
    bot.reply_to(m, f"ğŸ’’ ØªÙ… Ø§Ù„Ø²ÙˆØ§Ø¬! Ù…Ù‡Ø±: {format_money(dowry)}")

@bot.message_handler(func=lambda m: m.text == "Ø²ÙˆØ§Ø¬ÙŠ")
def my_marriage(m):
    rec = marriage_col.find_one({"chat_id": m.chat.id, "$or":[{"husband": m.from_user.id},{"wife": m.from_user.id}]})
    if not rec:
        bot.reply_to(m, "â— Ø£Ù†Øª ØºÙŠØ± Ù…ØªØ²ÙˆØ¬ Ù‡Ù†Ø§."); return
    partner_id = rec["wife"] if rec["husband"] == m.from_user.id else rec["husband"]
    try:
        partner = bot.get_chat_member(m.chat.id, partner_id).user
        bot.reply_to(m, f"ğŸ’ Ø£Ù†Øª Ù…ØªØ²ÙˆØ¬ Ù…Ù†: {partner.first_name} â€” Ù…Ù‡Ø±: {format_money(rec['dowry'])}")
    except:
        bot.reply_to(m, f"ğŸ’ Ù…ØªØ²ÙˆØ¬ â€” Ù…Ù‡Ø±: {format_money(rec['dowry'])}")

@bot.message_handler(func=lambda m: m.text == "Ø·Ù„Ø§Ù‚")
def divorce_cmd(m):
    rec = marriage_col.find_one({"chat_id": m.chat.id, "$or":[{"husband": m.from_user.id},{"wife": m.from_user.id}]})
    if not rec:
        bot.reply_to(m, "â— Ø£Ù†Øª ØºÙŠØ± Ù…ØªØ²ÙˆØ¬."); return
    marriage_col.delete_one({"_id": rec["_id"]})
    bot.reply_to(m, "âš–ï¸ ØªÙ… Ø§Ù„Ø·Ù„Ø§Ù‚.")

# === Ù…Ø¹Ø±Ø¶ ÙˆØ´Ø±Ø§Ø¡ Ùˆ Ù…Ù…ØªÙ„ÙƒØ§ØªÙŠ ===
@bot.message_handler(func=lambda m: m.text == "Ù…Ø¹Ø±Ø¶")
def show_shop(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    items = list(shops_col.find({}))
    msg = "ğŸ¬ Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¬Ø±:\n"
    for it in items:
        msg += f"- {it['name']} â€” {format_money(it['price'])} â€” Ø§Ø±Ø³Ù„ /buy {it['item_id']}\n"
    bot.reply_to(m, msg)

@bot.message_handler(commands=['buy'])
def buy_cmd(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    parts = m.text.split()
    if len(parts) < 2:
        bot.reply_to(m, "â— Ø§Ø³ØªØ®Ø¯Ù…: /buy <item_id>"); return
    item_id = parts[1]
    item = shops_col.find_one({"item_id": item_id})
    if not item:
        bot.reply_to(m, "â— Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯."); return
    acc = ensure_user_account(m.chat.id, m.from_user)
    if acc.get("balance",0) < item["price"]:
        bot.reply_to(m, "âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ."); return
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": -item["price"]}, "$push": {"assets": item}})
    record_transaction(m.chat.id, "buy", m.from_user.id, None, item["price"], note=item["item_id"])
    bot.reply_to(m, f"âœ… Ø§Ø´ØªØ±ÙŠØª {item['name']} Ø¨Ø³Ø¹Ø± {format_money(item['price'])}")

@bot.message_handler(func=lambda m: m.text == "Ù…Ù…ØªÙ„ÙƒØ§ØªÙŠ")
def my_assets(m):
    acc = ensure_user_account(m.chat.id, m.from_user)
    assets = acc.get("assets", [])
    if not assets:
        bot.reply_to(m, "ğŸ” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù…Ù…ØªÙ„ÙƒØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹."); return
    msg = "ğŸ· Ù…Ù…ØªÙ„ÙƒØ§ØªÙƒ:\n"
    for it in assets:
        msg += f"- {it.get('name')} â€” {format_money(it.get('price',0))}\n"
    bot.reply_to(m, msg)

# === ØªØ¨Ø±Ø¹ ===
@bot.message_handler(func=lambda m: m.text == "ØªØ¨Ø±Ø¹")
def donate_prompt(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    bot.reply_to(m, "ğŸ“¬ Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø®Øµ ÙˆØ§ÙƒØªØ¨: /donate <amount>")

@bot.message_handler(commands=['donate'])
def donate_cmd(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    if not m.reply_to_message:
        bot.reply_to(m, "â— Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…."); return
    try:
        amount = int(m.text.split()[1])
    except:
        bot.reply_to(m, "â— Ø§Ù„ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©."); return
    donor = ensure_user_account(m.chat.id, m.from_user)
    receiver = ensure_user_account(m.chat.id, m.reply_to_message.from_user)
    if donor.get("balance",0) < amount:
        bot.reply_to(m, "âŒ Ù…Ø¹Ù†Ø¯ÙƒØ´ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ."); return
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": -amount}})
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.reply_to_message.from_user.id}, {"$inc": {"balance": amount}})
    record_transaction(m.chat.id, "donate", m.from_user.id, m.reply_to_message.from_user.id, amount)
    bot.reply_to(m, f"âœ… ØªÙ… Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ù€ {format_money(amount)} Ø¥Ù„Ù‰ {m.reply_to_message.from_user.first_name}")

# === Ø§Ù†Ø´Ø§Ø¡ Ù†Ø§Ø¯ÙŠ ÙˆØ´Ø±Ø§Ø¡ Ù„Ø§Ø¹Ø¨ (Ù…Ø¨Ø³Ø·) ===
@bot.message_handler(func=lambda m: m.text == "Ø§Ù†Ø´Ø§Ø¡ Ù†Ø§Ø¯ÙŠ")
def create_club_prompt(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    bot.reply_to(m, "âœ³ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø¢Ù†:")
    bot.register_next_step_handler(m, create_club_do)

def create_club_do(m):
    name = m.text.strip()
    if not name:
        bot.reply_to(m, "â— Ø§Ù„Ø§Ø³Ù… ÙØ§Ø±Øº."); return
    club = {"chat_id": m.chat.id, "owner": m.from_user.id, "name": name, "players": [], "cash": 0}
    clubs_col.insert_one(club)
    bot.reply_to(m, f"âš½ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§Ø¯ÙŠ: {name}")

@bot.message_handler(func=lambda m: m.text == "Ø´Ø±Ø§Ø¡ Ù„Ø§Ø¹Ø¨")
def buy_player_prompt(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    bot.reply_to(m, "âœ³ï¸ Ø§ÙƒØªØ¨: /buyplayer <owner_id>")

@bot.message_handler(commands=['buyplayer'])
def buy_player_cmd(m):
    try:
        owner_id = int(m.text.split()[1])
    except:
        bot.reply_to(m, "â— Ø§Ù„ØµÙŠØºØ©: /buyplayer <owner_id>"); return
    club = clubs_col.find_one({"chat_id": m.chat.id, "owner": owner_id})
    if not club:
        bot.reply_to(m, "â— Ø§Ù„Ù†Ø§Ø¯ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯."); return
    price = random.randint(50,300)
    acc = ensure_user_account(m.chat.id, m.from_user)
    if acc.get("balance",0) < price:
        bot.reply_to(m, "âŒ Ù…Ø¹Ù†Ø¯ÙƒØ´ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ."); return
    player = {"name": f"Ù„Ø§Ø¹Ø¨{random.randint(1,9999)}", "skill": random.randint(1,100), "price": price}
    clubs_col.update_one({"_id": club["_id"]}, {"$push": {"players": player}})
    users_col.update_one({"chat_id": m.chat.id, "user_id": m.from_user.id}, {"$inc": {"balance": -price}})
    record_transaction(m.chat.id, "buyplayer", m.from_user.id, None, price)
    bot.reply_to(m, f"âœ… Ø§Ø´ØªØ±ÙŠØª Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ø¨Ù€ {format_money(price)} Ù„Ù†Ø§Ø¯ÙŠ {club['name']}")

# === Ø£Ù„Ø¹Ø§Ø¨ Ø¥Ø¶Ø§ÙÙŠØ© ÙˆØ£Ø³Ø¦Ù„Ø© ÙˆÙ…Ø´Ø§Ù‡ÙŠØ± ===
@bot.message_handler(func=lambda m: m.text == "ğŸ•¹ Ø§Ù„Ø¹Ø§Ø¨ Ø¬Ø¯ÙŠØ¯Ø©")
def new_games_menu(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸ§  Ø§Ø³Ø£Ù„Ù†ÙŠ Ø³Ø¤Ø§Ù„", "ğŸŒŸ Ù…Ø´Ø§Ù‡ÙŠØ±", "ğŸ” Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹ÙƒØ³")
    markup.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(m.chat.id, "Ø§Ø®ØªØ§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©:", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "ğŸ§  Ø§Ø³Ø£Ù„Ù†ÙŠ Ø³Ø¤Ø§Ù„")
def ask_question(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    # read random question from questions collection (fallback to sample)
    qdoc = questions_col.aggregate([{"$sample": {"size": 1}}])
    q = None
    for item in qdoc:
        q = item.get("text")
    if not q:
        # fallback
        q = random.choice([
            "Ù…Ø§ Ù‡Ùˆ Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ",
            "Ù…Ù† Ù…Ø¤Ø³Ø³ Ø´Ø±ÙƒØ© Ù…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØªØŸ",
            "ÙÙŠ Ø£ÙŠ Ù‚Ø§Ø±Ø© ØªÙ‚Ø¹ Ù…ØµØ±ØŸ"
        ])
    bot.reply_to(m, f"â“ Ø³Ø¤Ø§Ù„Ùƒ: {q}")

@bot.message_handler(func=lambda m: m.text == "ğŸŒŸ Ù…Ø´Ø§Ù‡ÙŠØ±")
def show_celebrity(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    celebs = ["Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­ âš½ï¸","ÙƒØ±ÙŠØ³ØªÙŠØ§Ù†Ùˆ Ø±ÙˆÙ†Ø§Ù„Ø¯Ùˆ âš½ï¸","Ù„ÙŠÙˆÙ†Ø§Ø±Ø¯Ùˆ Ø¯ÙŠ ÙƒØ§Ø¨Ø±ÙŠÙˆ ğŸ¬","Ø¥ÙŠÙ„ÙˆÙ† Ù…Ø§Ø³Ùƒ ğŸš€","Ø¨ÙŠÙˆÙ†Ø³ÙŠÙ‡ ğŸ¤"]
    bot.reply_to(m, f"ğŸ‘¤ Ø§Ù„Ù…Ø´Ù‡ÙˆØ±: {random.choice(celebs)}\nØ§Ø­Ø²Ø± Ø´Ø®ØµÙŠØªÙ‡ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ!")

@bot.message_handler(func=lambda m: m.text == "ğŸ” Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹ÙƒØ³")
def opposite_game(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    pairs = [("Ù„ÙŠÙ„","Ù†Ù‡Ø§Ø±"),("Ø³Ø¹ÙŠØ¯","Ø­Ø²ÙŠÙ†"),("ÙƒØ¨ÙŠØ±","ØµØºÙŠØ±"),("Ø­Ø§Ø±","Ø¨Ø§Ø±Ø¯")]
    w,o = random.choice(pairs)
    bot.reply_to(m, f"Ø§ÙƒØªØ¨ Ø¹ÙƒØ³ Ø§Ù„ÙƒÙ„Ù…Ø©: {w}")

# === ØªØ³Ù„ÙŠØ© ===
@bot.message_handler(func=lambda m: m.text == "ğŸ˜‚ ØªØ³Ù„ÙŠØ©")
def fun_menu(m):
    if not require_subscription(m.from_user.id):
        send_subscription_prompt(m.chat.id); return
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸ¤£ Ù†ÙƒØªØ©", "ğŸ’­ Ø­ÙƒÙ…Ø©", "ğŸ¯ Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©")
    markup.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(m.chat.id, "Ø§Ø®ØªØ§Ø±:", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "ğŸ¤£ Ù†ÙƒØªØ©")
def send_joke(m):
    jdoc = fun_col.aggregate([{"$sample": {"size": 1}}])
    joke = None
    for it in jdoc:
        joke = random.choice(it.get("jokes", []))
    if not joke:
        joke = "Ù…Ø§ÙÙŠØ´ Ù†ÙƒØª Ø§Ù„Ø¢Ù†."
    bot.reply_to(m, joke)

@bot.message_handler(func=lambda m: m.text == "ğŸ’­ Ø­ÙƒÙ…Ø©")
def send_wisdom(m):
    wdoc = fun_col.find_one() or {}
    wisdoms = wdoc.get("wisdoms", ["Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙƒÙ… Ø§Ù„Ø¢Ù†."])
    bot.reply_to(m, random.choice(wisdoms))

@bot.message_handler(func=lambda m: m.text == "ğŸ¯ Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©")
def send_fact(m):
    fdoc = fun_col.find_one() or {}
    facts = fdoc.get("facts", ["Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¢Ù†."])
    bot.reply_to(m, random.choice(facts))

# === Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø·ÙˆØ±: Ø§Ø°Ø§Ø¹Ø© Ùˆ Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ùˆ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­ØªÙˆÙ‰ ===
@bot.message_handler(func=lambda m: m.text == "ğŸ”§ Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø·ÙˆØ±")
def dev_menu(m):
    if m.from_user.id != DEV_ID:
        bot.reply_to(m, "âŒ Ø§Ù„Ø£Ù…Ø± Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø·ÙˆØ± ÙÙ‚Ø·."); return
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸ“¢ Ø§Ø°Ø§Ø¹Ø©", "ğŸ“¢ Ø§Ø°Ø§Ø¹Ø© Ù…Ø¬Ù…ÙˆØ¹Ø©", "âœï¸ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„", "â– Ø­Ø°Ù Ø³Ø¤Ø§Ù„")
    markup.add("â• Ø¥Ø¶Ø§ÙØ© Ù†ÙƒØªØ©", "â– Ø­Ø°Ù Ù†ÙƒØªØ©", "ğŸ§¾ Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª", "ğŸ”™ Ø±Ø¬ÙˆØ¹")
    bot.reply_to(m, "Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±:", reply_markup=markup)

# Ø§Ø°Ø§Ø¹Ø© Ø¹Ø§Ù…Ø©
@bot.message_handler(func=lambda m: m.text == "ğŸ“¢ Ø§Ø°Ø§Ø¹Ø©")
def start_broadcast(m):
    if m.from_user.id != DEV_ID:
        return
    bot.reply_to(m, "ğŸ“¢ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ø°Ø§Ø¹ØªÙ‡Ø§ Ø§Ù„Ø¢Ù†:")
    bot.register_next_step_handler(m, do_broadcast)

def do_broadcast(m):
    if m.from_user.id != DEV_ID:
        return
    text = m.text
    sent = 0; failed = 0
    # Ù†Ø±Ø³Ù„ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø­Ø³Ø§Ø¨ (Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø±ÙˆØ¨Ø§Øª)
    for u in users_col.find({"has_account": True}):
        try:
            bot.send_message(int(u["user_id"]), f"ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ±:\n\n{text}")
            sent += 1
        except:
            failed += 1
    bot.reply_to(m, f"âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ {sent} Ù…Ø³ØªØ®Ø¯Ù…. ÙØ´Ù„ Ø¹Ù†Ø¯ {failed}.")

# Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª
@bot.message_handler(func=lambda m: m.text == "ğŸ§¾ Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª")
def dev_stats(m):
    if m.from_user.id != DEV_ID: return
    total_users = users_col.count_documents({"has_account": True})
    total_balance = 0
    for u in users_col.find({"has_account": True}):
        total_balance += u.get("balance",0)
    bot.reply_to(m, f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©: {format_money(total_balance)}")

# Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ø¶Ø§ÙØ© / Ø­Ø°Ù)
@bot.message_handler(func=lambda m: m.text == "âœï¸ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„")
def add_question_prompt(m):
    if m.from_user.id != DEV_ID: return
    bot.reply_to(m, "âœï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø¢Ù†:")
    bot.register_next_step_handler(m, add_question)

def add_question(m):
    if m.from_user.id != DEV_ID: return
    q = m.text.strip()
    if q:
        questions_col.insert_one({"text": q})
        bot.reply_to(m, "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„.")
    else:
        bot.reply_to(m, "â— Ø§Ù„Ø³Ø¤Ø§Ù„ ÙØ§Ø±Øº.")

@bot.message_handler(func=lambda m: m.text == "â– Ø­Ø°Ù Ø³Ø¤Ø§Ù„")
def del_question_prompt(m):
    if m.from_user.id != DEV_ID: return
    bot.reply_to(m, "âœ‚ï¸ Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù„Ø­Ø°ÙÙ‡:")
    bot.register_next_step_handler(m, del_question)

def del_question(m):
    if m.from_user.id != DEV_ID: return
    q = m.text.strip()
    res = questions_col.delete_one({"text": q})
    if res.deleted_count:
        bot.reply_to(m, "âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„.")
    else:
        bot.reply_to(m, "â— Ù„Ù… Ø£Ø¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„.")

@bot.message_handler(func=lambda m: m.text == "â• Ø¥Ø¶Ø§ÙØ© Ù†ÙƒØªØ©")
def add_joke_prompt(m):
    if m.from_user.id != DEV_ID: return
    bot.reply_to(m, "âœï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ù†ÙƒØªØ© Ø§Ù„Ø¢Ù†:")
    bot.register_next_step_handler(m, add_joke)

def add_joke(m):
    if m.from_user.id != DEV_ID: return
    j = m.text.strip()
    if not j:
        bot.reply_to(m, "â— Ø§Ù„Ù†Øµ ÙØ§Ø±Øº."); return
    fun_col.update_one({}, {"$push": {"jokes": j}}, upsert=True)
    bot.reply_to(m, "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ÙƒØªØ©.")

@bot.message_handler(func=lambda m: m.text == "â– Ø­Ø°Ù Ù†ÙƒØªØ©")
def del_joke_prompt(m):
    if m.from_user.id != DEV_ID: return
    bot.reply_to(m, "âœ‚ï¸ Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ù†ÙƒØªØ© Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù„Ø­Ø°ÙÙ‡Ø§:")
    bot.register_next_step_handler(m, del_joke)

def del_joke(m):
    if m.from_user.id != DEV_ID: return
    j = m.text.strip()
    fun = fun_col.find_one() or {}
    if j in fun.get("jokes", []):
        fun_col.update_one({}, {"$pull": {"jokes": j}})
        bot.reply_to(m, "âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†ÙƒØªØ©.")
    else:
        bot.reply_to(m, "â— Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ù†ÙƒØªØ©.")

# === ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù†ØµÙŠØ© ===
@bot.message_handler(func=lambda m: not m.text)
def ignore_non_text(m):
    pass

# === ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ===
if __name__ == "__main__":
    print("Bot started...")
    # Ø§Ø³ØªØ®Ø¯Ù… infinity_polling Ø£Ùˆ polling ÙˆÙÙ‚ Ø­Ø§Ø¬ØªÙƒ
    bot.infinity_polling(timeout=60, long_polling_timeout=60)
